name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]

env:
  QT_VERSION: 6.7.0
  BUILD_TYPE: Release

jobs:
  # Windows æ„å»º (MinGW) - é¡¹ç›®ç›®å‰ä»…æ”¯æŒæ­¤å¹³å°
  build-windows-mingw:
    runs-on: windows-latest
    name: "Windows MinGW + Qt6 æ„å»º"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt with MinGW
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: windows
        target: desktop
        arch: win64_mingw
        tools: 'tools_mingw,qt.tools.win64_mingw900'
        cache: true

    - name: Setup MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-pkg-config

    - name: Setup PATH
      run: |
        echo "$Qt6_DIR/bin" >> $GITHUB_PATH
        echo "C:/msys64/mingw64/bin" >> $GITHUB_PATH
      shell: bash

    - name: Verify build environment
      run: |
        echo "=== éªŒè¯æ„å»ºç¯å¢ƒ ==="
        echo "Qt version:"
        qmake --version
        echo "GCC version:"
        gcc --version
        echo "CMake version:"
        cmake --version
        echo "Ninja version:"
        ninja --version
        echo "Qt installation path:"
        echo "$Qt6_DIR"
      shell: bash

    - name: Configure CMake
      run: |
        echo "=== é…ç½® CMake ==="
        cmake --preset=mingw
      shell: bash

    - name: Build project
      run: |
        echo "=== æ„å»ºé¡¹ç›® ==="
        cmake --build build-mingw --config ${{ env.BUILD_TYPE }}
      shell: bash

    - name: Run tests
      run: |
        echo "=== è¿è¡Œæµ‹è¯• ==="
        cd build-mingw
        ctest --output-on-failure --build-config ${{ env.BUILD_TYPE }}
      shell: bash

    - name: Package application
      run: |
        echo "=== æ‰“åŒ…åº”ç”¨ç¨‹åº ==="
        cd build-mingw
        if [ -f "src/app/DesktopPet.exe" ]; then
          mkdir -p ../dist
          cp src/app/DesktopPet.exe ../dist/
          
          # å¤åˆ¶Qtåº“å’Œèµ„æºæ–‡ä»¶
          windeployqt --dir ../dist --force ../dist/DesktopPet.exe
          
          # å¤åˆ¶MinGWè¿è¡Œæ—¶åº“
          cp /mingw64/bin/libgcc_s_seh-1.dll ../dist/ || true
          cp /mingw64/bin/libstdc++-6.dll ../dist/ || true
          cp /mingw64/bin/libwinpthread-1.dll ../dist/ || true
          
          echo "âœ… åº”ç”¨ç¨‹åºæ‰“åŒ…å®Œæˆ"
          ls -la ../dist/
        else
          echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          exit 1
        fi
      shell: bash

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: DesktopPet-Windows-MinGW
        path: |
          dist/
          !dist/**/*.pdb
        retention-days: 7

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-windows-mingw
        path: |
          build-mingw/Testing/
        retention-days: 3

  # ä»£ç è´¨é‡æ£€æŸ¥ - ä»…åœ¨Windowsç¯å¢ƒä¸‹è¿›è¡Œ
  code-quality:
    runs-on: windows-latest
    name: "ä»£ç è´¨é‡æ£€æŸ¥"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Qt (for header dependencies)
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: windows
        target: desktop
        arch: win64_mingw
        tools: 'tools_mingw'
        cache: true

    - name: Setup MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-clang-tools-extra

    - name: Code formatting check
      run: |
        echo "=== ä»£ç æ ¼å¼æ£€æŸ¥ ==="
        echo "æ£€æŸ¥ C++ ä»£ç æ ¼å¼..."
        
        # ä½¿ç”¨ clang-format æ£€æŸ¥æ ¼å¼ (å¦‚æœå¯ç”¨)
        if command -v clang-format &> /dev/null; then
          echo "ä½¿ç”¨ clang-format æ£€æŸ¥æ ¼å¼..."
          find src test -name "*.cpp" -o -name "*.h" | while read file; do
            if ! clang-format --dry-run --Werror "$file" > /dev/null 2>&1; then
              echo "âŒ æ–‡ä»¶ $file æ ¼å¼ä¸æ­£ç¡®"
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰æ–‡ä»¶æ ¼å¼æ­£ç¡®"
        else
          echo "âš ï¸ clang-format ä¸å¯ç”¨ï¼Œè·³è¿‡æ ¼å¼æ£€æŸ¥"
        fi
      shell: bash

    - name: Basic static analysis
      run: |
        echo "=== åŸºç¡€é™æ€åˆ†æ ==="
        echo "æ£€æŸ¥å¸¸è§çš„ä»£ç é—®é¢˜..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ˜æ˜¾çš„é—®é¢˜
        echo "æ£€æŸ¥å¤´æ–‡ä»¶åŒ…å«..."
        find src -name "*.h" | while read file; do
          if ! grep -q "#ifndef\|#pragma once" "$file"; then
            echo "âš ï¸ å¤´æ–‡ä»¶ $file å¯èƒ½ç¼ºå°‘åŒ…å«å®ˆå«"
          fi
        done
        
        echo "æ£€æŸ¥TODOå’ŒFIXMEæ³¨é‡Š..."
        todo_count=$(find src -name "*.cpp" -o -name "*.h" | xargs grep -i "todo\|fixme" | wc -l)
        if [ $todo_count -gt 0 ]; then
          echo "ğŸ“ å‘ç° $todo_count ä¸ªTODO/FIXMEæ³¨é‡Š"
          find src -name "*.cpp" -o -name "*.h" | xargs grep -n -i "todo\|fixme"
        fi
        
        echo "âœ… åŸºç¡€é™æ€åˆ†æå®Œæˆ"
      shell: bash

  # æ„å»ºéªŒè¯ - ç¡®ä¿åœ¨å¹²å‡€ç¯å¢ƒä¸­èƒ½å¤Ÿæ„å»º
  build-verification:
    runs-on: windows-latest
    name: "å¹²å‡€ç¯å¢ƒæ„å»ºéªŒè¯"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Qt with MinGW
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: windows
        target: desktop
        arch: win64_mingw
        tools: 'tools_mingw,qt.tools.win64_mingw900'
        cache: false  # ä¸ä½¿ç”¨ç¼“å­˜ï¼Œç¡®ä¿å¹²å‡€å®‰è£…

    - name: Setup MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja

    - name: Run development environment setup
      run: |
        echo "=== è¿è¡Œå¼€å‘ç¯å¢ƒè®¾ç½®è„šæœ¬ ==="
        # æ¨¡æ‹Ÿè¿è¡Œ setup-dev-env.bat çš„å…³é”®æ­¥éª¤
        echo "éªŒè¯å¼€å‘ç¯å¢ƒè®¾ç½®..."
        
        echo "æ£€æŸ¥Qt..."
        qmake --version
        
        echo "æ£€æŸ¥MinGW..."
        gcc --version
        
        echo "æ£€æŸ¥CMake..."
        cmake --version
        
        echo "âœ… å¼€å‘ç¯å¢ƒéªŒè¯å®Œæˆ"
      shell: bash

    - name: Configure and build (dry run)
      run: |
        echo "=== é…ç½®æ„å»º (éªŒè¯) ==="
        
        # åªé…ç½®ï¼Œä¸å®é™…æ„å»º
        cmake --preset=mingw
        
        # éªŒè¯æ„å»ºæ–‡ä»¶ç”Ÿæˆ
        if [ -f "build-mingw/CMakeCache.txt" ]; then
          echo "âœ… CMake é…ç½®æˆåŠŸ"
        else
          echo "âŒ CMake é…ç½®å¤±è´¥"
          exit 1
        fi
        
        # å¿«é€Ÿæ„å»ºæ£€æŸ¥
        cmake --build build-mingw --config ${{ env.BUILD_TYPE }} --target help
        
        echo "âœ… æ„å»ºéªŒè¯å®Œæˆ"
      shell: bash
