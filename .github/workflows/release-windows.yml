name: Release (Windows MinGW)

on:
  push:
    tags:
      - 'v*'

env:
  QT_VERSION: 6.7.0

jobs:
  release-windows:
    runs-on: windows-latest
    name: "å‘å¸ƒ Windows ç‰ˆæœ¬"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION_NUM=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
      shell: bash

    - name: Install Qt with MinGW
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: windows
        target: desktop
        arch: win64_mingw
        tools: 'tools_mingw,qt.tools.win64_mingw900'
        cache: true

    - name: Setup MinGW
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-nsis

    - name: Build release version
      run: |
        echo "=== æ„å»ºå‘å¸ƒç‰ˆæœ¬ ==="
        
        # é…ç½®å‘å¸ƒæ„å»º
        cmake --preset=mingw -DCMAKE_BUILD_TYPE=Release
        
        # æ„å»º
        cmake --build build-mingw --config Release
        
        echo "âœ… å‘å¸ƒç‰ˆæœ¬æ„å»ºå®Œæˆ"
      shell: bash

    - name: Run all tests
      run: |
        echo "=== è¿è¡Œå…¨éƒ¨æµ‹è¯• ==="
        cd build-mingw
        ctest --output-on-failure --build-config Release
        echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"
      shell: bash

    - name: Create release package
      run: |
        echo "=== åˆ›å»ºå‘å¸ƒåŒ… ==="
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release/DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp build-mingw/src/app/DesktopPet.exe release/DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}/
        
        # å¤åˆ¶èµ„æºæ–‡ä»¶
        if [ -f "resources.qrc" ]; then
          mkdir -p release/DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}/resources
          cp -r resources/* release/DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}/resources/ || true
        fi
        
        # ä½¿ç”¨ windeployqt å¤åˆ¶ Qt ä¾èµ–
        cd release/DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}
        windeployqt --release --force DesktopPet.exe
        
        # å¤åˆ¶ MinGW è¿è¡Œæ—¶åº“
        cp /mingw64/bin/libgcc_s_seh-1.dll . || true
        cp /mingw64/bin/libstdc++-6.dll . || true
        cp /mingw64/bin/libwinpthread-1.dll . || true
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > start.bat << 'EOF'
        @echo off
        echo Starting DesktopPet...
        DesktopPet.exe
        EOF
        
        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        cat > README.txt << 'EOF'
        DesktopPet ${{ steps.get_version.outputs.VERSION }}
        
        è¿™æ˜¯ä¸€ä¸ªæ¡Œé¢å® ç‰©åº”ç”¨ç¨‹åºã€‚
        
        è¿è¡Œæ–¹å¼ï¼š
        1. ç›´æ¥è¿è¡Œ DesktopPet.exe
        2. æˆ–è€…è¿è¡Œ start.bat
        
        ç³»ç»Ÿè¦æ±‚ï¼š
        - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
        - Qt 6.7.0 æˆ–å…¼å®¹ç‰ˆæœ¬ï¼ˆå·²åŒ…å«åœ¨å‘å¸ƒåŒ…ä¸­ï¼‰
        
        æ›´å¤šä¿¡æ¯è¯·è®¿é—®ï¼š
        https://github.com/Gao-Zuin/DesktopPet
        EOF
        
        cd ..
        
        # åˆ›å»ºZIPåŒ…
        7z a -tzip DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}-Windows.zip DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}/
        
        # åˆ›å»ºè‡ªè§£å‹å®‰è£…åŒ… (å¦‚æœæœ‰ NSIS)
        if command -v makensis &> /dev/null; then
          echo "åˆ›å»º NSIS å®‰è£…åŒ…..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ  NSIS è„šæœ¬
          echo "âš ï¸ NSIS å®‰è£…åŒ…åˆ›å»ºéœ€è¦é¢å¤–çš„è„šæœ¬é…ç½®"
        fi
        
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
        ls -la
      shell: bash

    - name: Generate changelog
      run: |
        echo "=== ç”Ÿæˆæ›´æ–°æ—¥å¿— ==="
        
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "ä» $PREVIOUS_TAG åˆ° ${{ steps.get_version.outputs.VERSION }} çš„æ›´æ”¹:" > CHANGELOG.txt
          echo "" >> CHANGELOG.txt
          
          # è·å–æäº¤å†å²
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD >> CHANGELOG.txt
        else
          echo "é¦–æ¬¡å‘å¸ƒç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }}" > CHANGELOG.txt
        fi
        
        echo "âœ… æ›´æ–°æ—¥å¿—ç”Ÿæˆå®Œæˆ"
        cat CHANGELOG.txt
      shell: bash

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: DesktopPet ${{ steps.get_version.outputs.VERSION }}
        body_path: CHANGELOG.txt
        draft: false
        prerelease: false
        files: |
          release/DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}-Windows.zip
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}-Windows
        path: |
          release/DesktopPet-${{ steps.get_version.outputs.VERSION_NUM }}-Windows.zip
        retention-days: 30

    - name: Notify release completion
      run: |
        echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
        echo "ç‰ˆæœ¬: ${{ steps.get_version.outputs.VERSION }}"
        echo "å¹³å°: Windows (MinGW)"
        echo "Qt ç‰ˆæœ¬: ${{ env.QT_VERSION }}"
        echo ""
        echo "å‘å¸ƒåŒ…å·²ä¸Šä¼ åˆ° GitHub Releases"
        echo "ä¸‹è½½é“¾æ¥: https://github.com/Gao-Zuin/DesktopPet/releases/tag/${{ steps.get_version.outputs.VERSION }}"
      shell: bash
